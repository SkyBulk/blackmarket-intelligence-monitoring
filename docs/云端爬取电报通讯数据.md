# 云端爬取电报通讯数据

## 1. 先前准备

-   Debian云服务器一台

-   安装MySQL
    -   在Debian上安装
    -   https://www.digitalocean.com/community/tutorials/how-to-install-the-latest-mysql-on-debian-10
        -   https://www.linuxidc.com/Linux/2019-08/159844.htm
    -   直接使用Docker安装：`docker run -itd --name mysql-test -p 3306:3306 -e MYSQL_ROOT_PASSWORD=Sz0329.. mysql`
    
-   Python3
-   Python3-pip



## 2. 爬取

以下是对TelegramSpider模块的使用。主要是通过Telegram API爬取账户的通讯信息、用户信息等。

### 2.1 安装依赖

```bash
$ python3 install -r requirements.txt
```



### 2.2 配置Telegram API

编辑文件`TelegramSpider - client.py`：

```python
# -*- coding: utf-8 -*-

from telethon import TelegramClient, sync
import socks

"""
Telegram config
"""
# Your API ID
api_id = 1244091
# Your API Hash
api_hash = "4018f9a21ed122f7bbe0b1413e7c4aae"
session_name = 'session_name'
#  Proxy settings, if you need
proxy_param = (socks.SOCKS5, 'localhost', 1086)

# Create an connection
client = TelegramClient(session_name, api_id, api_hash,
                            proxy=proxy_param).start()
```



### 2.3 配置MySQL相关配置

编辑文件`TelegramSpider - database.py`：

```python
# -*- coding: utf-8 -*-

import pymysql

MYSQL_HOST = 'localhost'
MYSQL_DB = 'YOUR_MYSQL_DATABASES NAME'
MYSQL_USER = 'USERNAME'
MYSQL_PASS = 'PASSWORD'

connection = pymysql.connect(host=MYSQL_HOST, user=MYSQL_USER,
                             password=MYSQL_PASS, db=MYSQL_DB,
                             charset='utf8mb4',
                             cursorclass=pymysql.cursors.DictCursor)
```



### 2.4 配置数据库结构

在这里我们需要执行写好的初始化mysql数据库的sql文件。首先，我们需要创建数据库，对应`telegram.sql`中的信息，我们创建名为telegram的数据库；

```bash
$ mysql -u root -p 
...
mysql> CREATE DATABASE telegram;
Query OK, 1 row affected (0.00 sec)
```

切换到telegram数据库：

```bash
mysql> USE telegram;
Database changed
```

执行初始化telegram的sql文件，使用命令：`source + sql文件绝对路径在根目录`:

```bash
mysql> source /root/XXXXXX/source/data/telegram.sql;
Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected, 1 warning (0.00 sec)

Query OK, 0 rows affected, 8 warnings (0.02 sec)

Query OK, 0 rows affected, 1 warning (0.00 sec)

Query OK, 0 rows affected, 3 warnings (0.01 sec)

Query OK, 0 rows affected, 1 warning (0.00 sec)

Query OK, 0 rows affected, 1 warning (0.01 sec)

Query OK, 0 rows affected (0.00 sec)
```



### 2.4 启动消息爬取

有三个模式，爬取通讯信息、发言用户、通讯录用户，以下是爬取通讯信息：

```bash
$ python start_crawl_message.py
```





## 3. 存储

对爬取数据存储到MySQL之后的操作。

### 3.1 直接操作数据库

// TODO 在代码中封装对MySQL中telegram数据库增删改查的操作，完成了一部分。

增加在`db - connect2db.py`的`TelegramMessage`类中：

```python
class TelegramMessage(Base):
    """
    Telegram的消息类
    用以处理爬虫获取到的Telegram消息的数据，包含以下几个方法：
    - 增加消息
    - 删除消息
    - 修改消息
    - 查询消息
    """

    # 设置对象化表的名字:
    __tablename__ = 'message'

    # 表的结构:
    id = Column(String(20), primary_key=True)
    message_id = Column(String(20))
    chat_id = Column(String(20))
    message = Column(String(1000))
    date = Column(String(20))
    from_id = Column(String(20))
    is_reply = Column(String(20))
    reply_to_msg_id = Column(String(20))
    is_channel = Column(String(20))
    is_group = Column(String(20))
    media_file = Column(String(1000))

    def add_message(self, message_dict):
        """
        方法：增加消息
        """

        # 创建session对象:
        session = DBSession()
        # 创建新User对象:
        for key in message_dict.keys():
            # print(message_dict[key])
            new_message = TelegramMessage(id=message_dict[key][0], message_id=message_dict[key][1], chat_id=message_dict[key][2]
                                          , message=message_dict[key][3], date=message_dict[key][4], from_id=message_dict[key][5])
            # 添加到session:
            session.add(new_message)
            # 提交即保存到数据库:
            session.commit()
        # 关闭session:
        session.close()
```







### 3.2 对接到elasticsearch

// TODO xiaoyu



## Tips

### Debian上重置MySQL密码

-   参考：https://www.vultr.com/docs/reset-mysql-root-password-on-debian-ubuntu
    -   `UPDATE user SET password=PASSWORD('YOUR_NEW_PASSWORD') WHERE user='root';`
    -   `FLUSH PRIVILEGES;`



## References

\[1]